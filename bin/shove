#!/usr/bin/env ruby

$:.unshift File.dirname(__FILE__) + "/../lib"

require "optparse"
require "shove"

$ymlpath = File.expand_path("~/.shove.yml") 

def configure

  def getinput text
    print text
    STDIN.gets.strip
  end

  access = {}
  
  loop do
    
    puts "Please enter your App information."
    puts "You can find your API access information @ https://shove.io/apps"
    
    access[:app_id] = getinput "Enter App Id: "
    access[:app_key] = getinput "Enter App Key: "
    access[:api_url] = getinput "Enter Host (Blank for default): "

    Shove.configure access

    if Shove.valid?
      puts "Unable to validate app settings.  Error: #{check.message}"
    else
      puts "API Settings accepted.  Moving on..."
      break
    end
    
  end

  File.open($ymlpath, "w") do |f|
    f << access.to_yaml
  end

end

# get network and key
unless FileTest.exist?($ymlpath)
  configure
end

Shove.configure($ymlpath)

options = {
}

ARGV.options do |o|
  o.on("-h", "--help") { command = "help" }
  o.on("-v", "--version") { options[:command] = "version" }
  o.on("-c", "--channel") { |channel| 
    options[:channel] = channel 
  }
  o.on("-u", "--client") { |client|
    options[:client] = client
  }
  o.on("-m", "--message") { |message|
    options[:message] = message
  }
  o.parse!
end

begin
  args = ARGV.dup
  ARGV.clear
  command = args.shift || options[:command]
  raise Exception unless command && Shove.respond_to?(command)

  if command == "publish"
    Shove.channel(options[:channel]).publish(options[:message])
  end

rescue Exception => ex
  abort File.read(__FILE__).split("__END__").last
end

__END__
Usage: shove command
       shove broadcast channel event data

OPTIONS

  -h, --help
    Show this message

COMMANDS

  publish         Broadcasts a message to your network

  hosts           List available hosts for your network

  direct          Send a message directly to a user

  authorize       Authorize a channel subscription

  debug           Logs all messages for a given app

  reconfigure     Reconfigures the default app
